<%

from brewer.HistoryHandler import HistoryHandler

import os
%>

<html>

<head>

<title>PyBrewer ${Brewer.version}</title>

<script>

function toggleRelay() {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'rest/relay/toggle');

    xhr.onerror = function() {
        alert('toggle failed (error: ' + xhr.status + ')');
    };

    xhr.send()
}

function refreshStatus() {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'rest/status');

    xhr.onload = function() {
        offColor = '#FFFF33'

        onColor = '#00AAff'

        invalidTemperature = 99999999

        var status = JSON.parse(xhr.response);

        colorStr = status.temp != invalidTemperature ? (status.temp + 'C' ) : '?';

        document.getElementById("temperature").innerHTML = colorStr;

        if(status.temp == invalidTemperature) {
            document.getElementById("temperature").style.color = '#ffffff'
        }
        else if(status.temp >= status.temperature_controller_target_temp) {
            document.getElementById("temperature").style.color = '#ff0000'
        }
        else{
            document.getElementById("temperature").style.color = '#00ffff'
        }

        document.getElementById("relay_state").innerHTML = (status.relay_on ? 'ON' : 'OFF');

        document.getElementById("relay_state").style.color = status.relay_on ? onColor : offColor;

        document.getElementById("temp_control_running").innerHTML = (status.temperature_controller_running ? 'ON' : 'OFF');

        document.getElementById("temp_control_running").style.color = status.temperature_controller_running ? onColor : offColor;

        document.getElementById("relayControlButton").disabled = status.temperature_controller_running

        status.temperature_controller_running

        setTimeout(refreshStatus,
            1000)
    };

    xhr.send()
}

function toggleTempControl() {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'rest/temperature/controller/toggle');

    xhr.onerror = function() {
        alert('toggle failed (error: ' + xhr.status + ')');
    };

    xhr.send()
}

refreshStatus()


</script>


<style>
    html, body {
        background-color: black;
        width: 100%;
        font-family: "Courier New", Times, serif;
        color: #00ff00;
    }

    td {

        font-weight: bold;
        font-size: large;
        padding: 12px 12px 12px 12px;
    }
    table {
    margin: 0 auto;

    }

    h2 {
    text-decoration: underline;
    }

</style>

<link rel="icon" href="/favicon.png"/>


</head>

<body>


<h1> PyBrewer ${Brewer.version} </h1>
</br>
</br>

<table>

    <tr><td colspan=2> <h2> Temperature </h2> </td></tr>

    <tr>
        <td> Probe temperature </td>
        <td id="temperature"> </td>
    </tr>

    <tr><td></br></td></tr>
    <tr><td colspan=2> <h2> Relay </h2> </td></tr>

    <tr>
        <td> Relay state </td>
        <td id="relay_state"> </td>
        <td> <button id="relayControlButton" onClick="toggleRelay()"> toggle </button> </td>
    </tr>

    <tr><td></br></td></tr>
    <tr><td colspan=2> <h2> Controller </h2> </td></tr>

    <tr>
        <td> Temperature control </td>
        <td id="temp_control_running"> </td>
        <td> <button onClick="toggleTempControl()"> toggle </button> </td>
    </tr>

    <tr>
        <td> Target temperature </td>
        <td> ${Brewer.temperatureControl.targetTemperatureCelsius} </td>
    </tr>

</table>


<table>

<tr><th>History</th></tr>
%for entry in Brewer.getModule(HistoryHandler).getRecords():

<tr>
<td>

<a href="/history?entry=${entry}"> ${entry} </a> </td>
</tr>

% endfor

</table>


</body>

</html>
