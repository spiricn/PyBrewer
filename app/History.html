<%

from brewer.HistoryHandler import HistoryHandler




samples = []

pointRadius = 5

if 'entry' in request.params:
    samples = Brewer.getModule(HistoryHandler).getSamples(request.params['entry'][0])
    pointRadius = 0

time = [date + 'T' + time for date, time,temperature in samples]
temperature = [temperature for date, time,temperature in samples]


%>

<%include file="Header.html"/>

<script src="/js/Chart.js"></script>

<style>

div {
 position: absolute;
    top: 0; right: 0; bottom: 0; left: 0;
}

</style>
</head>

<body>


<div>
<canvas id="myChart"></canvas>
</div>

</body>



<script>

function update() {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'rest/temperature/get');

    xhr.onload = function() {
        var res = JSON.parse(xhr.response);

        var time = new Date();
        var temperature = res.res;

        console.log('new sample: '+ time + ' , ' + temperature);

        data.push({x: time, y: temperature});

        chart.update();

        setTimeout(update, 2000);
    }

    xhr.onerror = function() {
        console.log("error fetching temperature");

        setTimeout(update, 1000);
    }

    xhr.send()
}

% if 'entry' not in request.params:
update();
% endif

var time = ${time};

var temperature = ${temperature};

var data = []

for(var i=0; i<time.length; i++){
    data.push({x: new Date(time[i]), y: temperature[i]});
}

var chart = new Chart(document.getElementById("myChart"), {
  type: 'line',
  data: {
    datasets: [
        {
            data: data,
            label: "Temperature",
            borderColor: "#00FF00",
            fill: false,
            showLine: true,
            pointRadius: ${pointRadius},
            pointBackgroundColor : "#a01b1b",
            cubicInterpolationMode: 'cubic'
        },

    ]
  },
  options: {
    title: {
      responsive: true,
      display: true,
      text: 'Temperature history C'
    },
    tooltips: {
                        position: 'nearest',
                        mode: 'index',
                        intersect: false,
                        yPadding: 10,
                        xPadding: 10,
                        caretSize: 8,
                        backgroundColor: 'rgba(72, 241, 12, 1)',
                        borderColor: 'rgba(0,0,0,1)',
                        borderWidth: 4
    },
    scales: {
        yAxes: [{
            display: true,
            ticks: {
                min: 28,
                stepSize: 1,
                max: 19
            }

        }],
        xAxes: [{
            display: true,
            type: 'time'
        }]
    }
  }
});
</script>




</html>