<%

from brewer.HistoryHandler import HistoryHandler
from brewer.HardwareHandler import HardwareHandler
from brewer.AComponent import ComponentType

sensorValueMultiplier = 17

today = True

if 'entry' in request.params:
    today = True if  request.params['entry'][0] == Brewer.getModule(HistoryHandler).getRecords()[0] else Flase

entry = request.params['entry'][0]

%>

<%include file="Header.html"/>

<script src="/js/Chart.js"></script>
<script src="/js/hammer.min.js"></script>
<script src="/js/chart.zoom.js"></script>
<script src="/js/moment.min.js"></script>

<style>

div {
 position: absolute;
    top: 100; right: 0; bottom: 0; left: 0;
}

</style>
</head>

<body>

<%include file="Navbar.html"/>


<div>

<a class="main" href="javascript:chart.resetZoom();"> Reset zoom </a>

<canvas id="myChart"></canvas>
</div>

</body>



<script>

function formatTime(time) {
    return moment(new Date(time)).format("HH : mm : ss")
}

function init() {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'rest/history/getComponents?record=${entry}');
    
    xhr.onload = function() {
        console.log('start ' + xhr);
        var components = JSON.parse(xhr.response).res;
        
        for(var i=0; i<components.length; i++) {
            var component = components[i];
            
            console.log('process ' + component)

            var getNumComponentsXhr  = new XMLHttpRequest();
            getNumComponentsXhr.open('POST', 'rest/history/getNumSamples?record=${entry}&component=' + component);
            
            getNumComponentsXhr.onload = function() {
                var numSamples = JSON.parse(getNumComponentsXhr.response).res;
                
                console.log('num samples ' + component + " " + numSamples + "\n");
                
                
                var pageSize = 50;
                
                for(var pageIndex=0; pageIndex<5; pageIndex++){
                    console.log('get page ' + pageIndex);

                    var getSamplesXhr  = new XMLHttpRequest();
                    getSamplesXhr.open('POST', 
                            'rest/history/getSamples?record=${entry}&component=' + component + '&startIndex=' + (pageIndex*pageSize) + '&endIndex=' + ((pageIndex+1)*pageSize));
                    
                    getSamplesXhr.onload = function() {
                      console.log('loaded ' + pageIndex );  
                      
                      var compSamples = JSON.parse(getSamplesXhr.response).res;
                      
                      for(var i in compSamples){
                          
                          var samples = compSamples[i];
                          
                          for(var sampleIdx in samples){
                              
                              data["component" + component.replace(' ', '_')].push(
                                      {x : new Date(samples[sampleIdx][0] + 'T' + samples[sampleIdx][1]), y : samples[sampleIdx][2]
                                      });
                          }
                      }
                      
                      chart.update();
                      console.log('done');
                      
                    };
                    getSamplesXhr.send();
                    
                    break;
                }
            }
            
            getNumComponentsXhr.send();
            
            break;
        }
    }
    
    xhr.send()
}
function update() {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'rest/history/get');

    xhr.onload = function() {
        var res = JSON.parse(xhr.response).res;

        var time = new Date();

        for(var component in res){
            var multiplier = res[component].type == 'SWITCH' ? ${sensorValueMultiplier} : 1.0;
            
            data["component" + component.replace(' ', '_')].push(
                    {x : time, y : res[component].value * multiplier
                    });
        }

        chart.update();

        setTimeout(update, 100);
    }

    xhr.onerror = function() {
        console.log("error fetching temperature");

        setTimeout(update, 100);
    }

    xhr.send()
}

var data = {};

% for component in Brewer.getModule(HardwareHandler).getComponents():
    data["component${component.name.replace(' ', '_')}"] = [];
% endfor


init();
% if today:
//update();
% endif


var chart = new Chart(document.getElementById("myChart"), {
  type: 'line',
  data: {
    datasets: [
        % for index, component in enumerate(Brewer.getModule(HardwareHandler).getComponents()):
            
        {
            data: data["component${component.name.replace(' ', '_')}"],
            label: "${component.name}",
            borderColor: "${component.color}",
            fill: false,
            showLine: true,
            pointRadius: 0,
            cubicInterpolationMode: 'cubic'
        },

        % endfor
    ]
  },

  options: {
    title: {
      responsive: true,
      display: true,
      text: 'Temperature history C'
    },
    tooltips: {
                        position: 'nearest',
                        mode: 'index',
                        intersect: false,
                        yPadding: 10,
                        xPadding: 10,
                        caretSize: 8,
                        backgroundColor: 'rgba(72, 241, 12, 1)',
                        borderColor: 'rgba(0,0,0,1)',
                        borderWidth: 4,

                        // Create custom tooltip title)
                        callbacks: {
                            title: function(tooltipItem){
                                return formatTime(tooltipItem[0].xLabel);
                            }
                        }
    },
    scales: {
        yAxes: [{
            display: true,
            ticks: {
                stepSize: 1
            },
            labelString: 'Temperature'

        }],
        xAxes: [{
            display: true,

            // NOTE: needs to be linear, otherwise the zoom plugin breaks (known bug)
            // that's why we can't use time type and have to manually set datapoint labels
            type: 'linear',
            labelString: 'Time',

            // Create custom labels for X axis ticks
            ticks: {
                callback: function(tick) {
                    return formatTime(tick);
                }
            }

        }]
    },

    // Container for zoom options
    zoom: {
        // Boolean to enable zooming
        enabled: true,

        drag: true,
        // Zooming directions. Remove the appropriate direction to disable
        // Eg. 'y' would only allow zooming in the y direction
        mode: 'xy'
    },
  }
});
</script>




</html>