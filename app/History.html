<%

from brewer.HistoryHandler import HistoryHandler

samples = []


today = True

if 'entry' in request.params:
    samples = Brewer.getModule(HistoryHandler).getSamples(request.params['entry'][0])
    today = True if  request.params['entry'][0] == Brewer.getModule(HistoryHandler).getRecords()[0] else Flase
time = [date + 'T' + time for date, time, temperature, target, relay in samples]
temperature = [temperature for date, time,temperature, target, relay in samples]
target = [0.0 if not target else target for date, time,temperature, target, relay in samples]
relay = [0 if not relay else 20 for date, time,temperature, target, relay in samples]


%>

<%include file="Header.html"/>

<script src="/js/Chart.js"></script>
<script src="/js/hammer.min.js"></script>
<script src="/js/chart.zoom.js"></script>
<script src="/js/moment.min.js"></script>

<style>

div {
 position: absolute;
    top: 100; right: 0; bottom: 0; left: 0;
}

</style>
</head>

<body>

<%include file="Navbar.html"/>


<div>

<a class="main" href="javascript:chart.resetZoom();"> Reset zoom </a>

<canvas id="myChart"></canvas>
</div>

</body>



<script>

function formatTime(time) {
    return moment(new Date(time)).format("HH : mm : ss")
}

function update() {
    var xhr = new XMLHttpRequest();
    xhr.open('POST', 'rest/history/get');

    xhr.onload = function() {
        var res = JSON.parse(xhr.response).res;

        var time = new Date();

        tempData.push({x: time, y: res.temperature});
        targetData.push({x: time, y: res.target});
        relayData.push({x: time, y: res.relay ? 20 : 0});

        chart.update();

        setTimeout(update, 2000);
    }

    xhr.onerror = function() {
        console.log("error fetching temperature");

        setTimeout(update, 1000);
    }

    xhr.send()
}

var time = ${time};

var temperature = ${temperature};

var target = ${target};

var relay= ${relay};

var tempData = [];

var targetData = [];

var relayData = [];

for(var i=0; i<time.length; i++){
    tempData.push({x: new Date(time[i]), y: temperature[i]});
    targetData.push({x: new Date(time[i]), y: target[i]});
    relayData.push({x: new Date(time[i]), y: relay[i]});
}


% if today:
update();
% endif

var chart = new Chart(document.getElementById("myChart"), {
  type: 'line',
  data: {
    datasets: [
        {
            data: tempData,
            label: "Temperature",
            borderColor: "#00FF00",
            fill: false,
            showLine: true,
            pointRadius: 0,
            cubicInterpolationMode: 'cubic'
        },

        {
            data: targetData,
            label: "Target",
            borderColor: "#FF0000",
            fill: false,
            showLine: true,
            pointRadius: 0,
            cubicInterpolationMode: 'cubic'
        },
        
        {
            data: relayData,
            label: "Relay",
            borderColor: "#0000FF",
            fill: false,
            showLine: true,
            pointRadius: 0,
            cubicInterpolationMode: 'cubic'
        },

    ]
  },

  options: {
    title: {
      responsive: true,
      display: true,
      text: 'Temperature history C'
    },
    tooltips: {
                        position: 'nearest',
                        mode: 'index',
                        intersect: false,
                        yPadding: 10,
                        xPadding: 10,
                        caretSize: 8,
                        backgroundColor: 'rgba(72, 241, 12, 1)',
                        borderColor: 'rgba(0,0,0,1)',
                        borderWidth: 4,

                        // Create custom tooltip title)
                        callbacks: {
                            title: function(tooltipItem){
                                return formatTime(tooltipItem[0].xLabel);
                            }
                        }
    },
    scales: {
        yAxes: [{
            display: true,
            ticks: {
                stepSize: 1
            },
            labelString: 'Temperature'

        }],
        xAxes: [{
            display: true,

            // NOTE: needs to be linear, otherwise the zoom plugin breaks (known bug)
            // that's why we can't use time type and have to manually set datapoint labels
            type: 'linear',
            labelString: 'Time',

            // Create custom labels for X axis ticks
            ticks: {
                callback: function(tick) {
                    return formatTime(tick);
                }
            }

        }]
    },

    // Container for zoom options
    zoom: {
        // Boolean to enable zooming
        enabled: true,

        drag: true,
        // Zooming directions. Remove the appropriate direction to disable
        // Eg. 'y' would only allow zooming in the y direction
        mode: 'xy'
    },
  }
});
</script>




</html>